<!DOCTYPE html>

<meta charset="utf-8">
<style>

body, html {
  font-size: 12px;
  font-family: 'Roboto', 'Inconsolata', sans-serif;
  margin: 0;
  text-align: center;
}

svg {
  border: 1px black solid;
}

.legend, .legendCells {
  /*text-align: center;*/
}

.count-square:hover{
  /*stroke: black;*/
  stroke-width: 1px;
  stroke: rgb(253,100,103); 
}

/* Axis styling */

.axis path {
  stroke: black;
  opacity: 0.1;
}

/* Interaction styles */

.label-highlighted {
  fill: white;
}

.highlight-rect {
  fill: rgb(4,108,154);
}

.rect-hidden {
  display: none;
}

</style>
<body>
<title>/r/NBA Users by Team and Home State</title>
<h1 class="title">/r/NBA Users by Team and Home State</h1>

<div class="heatmap"></div>

<script src="//d3js.org/d3.v4.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.4/lodash.min.js"></script>
<link href="https://fonts.googleapis.com/css?family=Inconsolata|Alegreya+Sans+SC|Roboto" rel="stylesheet">
<script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3-legend/2.24.0/d3-legend.min.js"></script>

<script>

const cellSize = 15;
const margin = {top: 175, right: 125, bottom: 0, left: 125},
      width = cellSize*52,
      height = cellSize*32;

d3.csv("team_by_home_state.csv", function(error, data) {
  
  // const teams = _.uniq(data.map(d => d.team));
  // Order teams by region, roughly
  const teams = ['Toronto Raptors', 'Boston Celtics', 'New York Knicks', 'Brooklyn Nets',
                 'Philadelphia 76ers', 'Washington Wizards', 'Charlotte Hornets', 
                 'Memphis Grizzlies', 'Atlanta Hawks', 'Miami Heat', 'Orlando Magic',
                 'Milwaukee Bucks', 'Minnesota Timberwolves', 'Detroit Pistons', 'Chicago Bulls',
                 'Cleveland Cavaliers', 'Indiana Pacers', 'New Orleans Pelicans', 'Houston Rockets',
                 'Dallas Mavericks', 'San Antonio Spurs', 'Oklahoma City Thunder', 'Denver Nuggets',
                 'Utah Jazz', 'Phoenix Suns', 'Sacramento Kings', 'Golden State Warriors', 
                 'Los Angeles Lakers', 'LA Clippers', 'Seattle Super Sonics', 'Portland Trail Blazers', 
                 'Other']

  // const states = _.uniq(data.map(d => d.state));
  // Order states by region, roughly
  const states = ["Maine", "New Hampshire", "Vermont", "Massachusetts", "Connecticut",
                  "Rhode Island", "New York", "New Jersey", "Pennsylvania", "Delaware", "Maryland",
                  "Virginia", "West Virginia", "North Carolina", "South Carolina", 
                  "Georgia", "Florida", "Kentucky", "Tennessee", "Alabama", "Mississippi", "Ohio", 
                  "Michigan", "Indiana", "Illinois", "Wisconsin", "Minnesota", "Iowa", "Missouri",
                  "Kansas", "Nebraska", "South Dakota", "North Dakota", "Arkansas", "Louisiana", 
                  "Oklahoma", "Texas", "Montana", "Wyoming", "Colorado", "Idaho", "Utah", "New Mexico", 
                  "Arizona", "Nevada", "California", "Oregon", "Washington", "Alaska", "Hawaii", "Other"]

  const xScale = d3.scaleBand()
    .domain(states)
    .range([0, width])
    .paddingInner(0.1)
    .paddingOuter(0);

  const yScale = d3.scaleBand()
    .domain(teams)
    .range([0, height])
    .paddingInner(0.1)
    .paddingOuter(0);

  const countMax = _.max(data.map(d => d.count));
  const color = d3.scaleSequential(d3.interpolateBlues);
  const colorScale = d3.scaleLog() // Is using a log scale wrong? Hmm...
    .domain([1, countMax])
    .range([d3.interpolateBlues(0), d3.interpolateBlues(1)])

  const svg = d3.selectAll(".heatmap")
    .append("svg")
      .attr("width", width + margin.left + margin.right)
      .attr("height", height + margin.top + margin.bottom)
    .append("g")
      .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

  // Interactivity functions

  const mouseover = (d) => {
    mousemove.call(this);
  }

  const mouseout = (d) => {
    d3.selectAll(".t-"+_.kebabCase(d.team))
      .classed("label-highlighted", false)
    d3.selectAll(".s-"+_.kebabCase(d.state))
      .classed("label-highlighted", false)
    d3.selectAll(".t-rect")
      .classed("rect-hidden", true)
    d3.selectAll(".s-rect")
      .classed("rect-hidden", true)
  }

  const mousemove = (d) => {
    d3.selectAll(".t-"+_.kebabCase(d.team))
      .classed("label-highlighted", true)
    d3.selectAll(".s-"+_.kebabCase(d.state))
      .classed("label-highlighted", true)
    d3.selectAll(".t-rect")
      .classed("rect-hidden", false)
      .attr("y", yScale(d.team))
    d3.selectAll(".s-rect")
      .classed("rect-hidden", false)
      .attr("x", xScale(d.state))


  }

  // Construct the actual heatmap

  svg.selectAll("rect")
    .data(data).enter()
    .append("rect")
    .attr("class", "count-square")
    .attr("x", d => xScale(d.state))
    .attr("y", d => yScale(d.team))
    .attr("width", xScale.bandwidth())
    .attr("height", yScale.bandwidth())
    .attr("fill", d => colorScale(d.count))
    .on("mouseover", mouseover)
    .on("mousemove", mousemove)
    .on("mouseout", mouseout);

  // Add background rects for highlighting 

  svg.append("rect")
    .attr("class", "highlight-rect t-rect")
    .attr("x", -margin.left)
    .attr("y", 0)
    .classed("rect-hidden", true)
    .attr("width", margin.left)
    .attr("height", yScale.bandwidth());

  svg.append("rect")
    .attr("class", "highlight-rect s-rect")
    .attr("y", -margin.left)
    .attr("x", 0)
    .classed("rect-hidden", true)
    .attr("height", margin.left)
    .attr("width", xScale.bandwidth());

  // Add axes

  yAxis = d3.axisLeft()
    .tickSize(0)
    .scale(yScale);

  svg.append("g")
    .attr("class", "y axis")
    .call(yAxis)
  .selectAll("text")
    .attr("class", d => "t-"+_.kebabCase(d));

  xAxis = d3.axisTop()
    .tickSize(0)
    .scale(xScale);

  svg.append("g")
    .attr("class", "x axis")
    .call(xAxis)
  .selectAll("text")
    .attr("dx", "-0.5rem")
    .attr("dy", xScale.bandwidth()/4)
    .attr("class", d => "s-"+_.kebabCase(d))
    .attr("transform", "rotate(90)")
    .attr("alignment-baseline", "middle")
    .style("text-anchor", "end");

  // Add legend
  
  var legend = d3.legendColor()
      .cells([1, 5, 10, 50, countMax])
      .shapeWidth(2*cellSize)
      .labelFormat(d3.format("2"))
      .orient('horizontal')
      .scale(colorScale);

  svg.append("g")
    .attr("class", "legend")
    .attr("text-anchor", "middle")
    .attr("transform", "translate(" + (width/2) + ",-" + (margin.top) + ")")
    .call(legend)
  // .append("text")
  //   .attr("transform", "translate(" + (width/2) + ",-" + (margin.top) + ")")
  //   .attr("stroke", "black")
  //   .text("Count of folks");

});

</script>